pipeline {
    agent any

    environment {
        BACKEND_DIR = 'BE/SSAIREN'
        DOCKER_COMPOSE = 'sudo docker compose'
        CONTAINER_NAME = 'backend'
    }

    stages {
        stage('Checkout') {
            steps {
                echo '======================================'
                echo 'Git Repository Checkout'
                echo '======================================'
                checkout scm
                sh 'git branch'
                sh 'pwd'
                sh 'ls -la'
            }
        }

        stage('Environment Check') {
            steps {
                echo '======================================'
                echo 'Checking Build Environment'
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    sh '''
                        echo "ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: $(pwd)"
                        echo "ÌååÏùº Î™©Î°ù:"
                        ls -la
                        echo "Docker Î≤ÑÏ†Ñ:"
                        docker --version
                        echo "Docker Compose Î≤ÑÏ†Ñ:"
                        docker compose version
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo '======================================'
                echo 'Building Docker Image'
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    sh '''
                        ${DOCKER_COMPOSE} build --no-cache
                    '''
                }
            }
        }

        stage('Stop Old Container') {
            steps {
                echo '======================================'
                echo 'Stopping Old Containers'
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    sh '''
                        ${DOCKER_COMPOSE} down || true
                        echo "Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ ÏôÑÎ£å"
                    '''
                }
            }
        }

        stage('Deploy New Container') {
            steps {
                echo '======================================'
                echo 'Deploying New Containers'
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    sh '''
                        ${DOCKER_COMPOSE} up -d
                        echo "ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë ÏôÑÎ£å"
                    '''
                }
            }
        }

        stage('Wait for Startup') {
            steps {
                echo '======================================'
                echo 'Waiting for Application Startup'
                echo '======================================'
                script {
                    echo "Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë ÎåÄÍ∏∞ Ï§ë (30Ï¥à)..."
                    sleep(time: 30, unit: 'SECONDS')
                }
            }
        }

        stage('Health Check') {
            steps {
                echo '======================================'
                echo 'Running Health Check'
                echo '======================================'
                script {
                    def maxRetries = 5
                    def retryCount = 0
                    def healthCheckPassed = false

                    while (retryCount < maxRetries && !healthCheckPassed) {
                        try {
                            def result = sh(
                                script: 'sudo docker exec ${CONTAINER_NAME} wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health/liveness',
                                returnStatus: true
                            )

                            if (result == 0) {
                                healthCheckPassed = true
                                echo "‚úì Health Check ÏÑ±Í≥µ!"
                            } else {
                                retryCount++
                                if (retryCount < maxRetries) {
                                    echo "Health Check Ïã§Ìå®. Ïû¨ÏãúÎèÑ ${retryCount}/${maxRetries}..."
                                    sleep(time: 10, unit: 'SECONDS')
                                }
                            }
                        } catch (Exception e) {
                            retryCount++
                            if (retryCount < maxRetries) {
                                echo "Health Check Ïò§Î•ò. Ïû¨ÏãúÎèÑ ${retryCount}/${maxRetries}..."
                                sleep(time: 10, unit: 'SECONDS')
                            }
                        }
                    }

                    if (!healthCheckPassed) {
                        error "‚úó Health Check Ïã§Ìå®! BackendÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo '======================================'
                echo 'Verifying Deployment'
                echo '======================================'
                sh '''
                    echo "Ïã§Ìñâ Ï§ëÏù∏ Ïª®ÌÖåÏù¥ÎÑà:"
                    sudo docker ps | grep backend

                    echo ""
                    echo "Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ (ÏµúÍ∑º 20Ï§Ñ):"
                    sudo docker logs ${CONTAINER_NAME} --tail 20

                    echo ""
                    echo "ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏:"
                    sudo docker network inspect ssairen-net | grep -A 5 backend || echo "ssairen-net ÎÑ§Ìä∏ÏõåÌÅ¨Ïóê backend ÏóÜÏùå"
                '''
            }
        }
    }

    post {
        success {
            echo '======================================'
            echo 'üéâ CI/CD ÌååÏù¥ÌîÑÎùºÏù∏ ÏÑ±Í≥µ!'
            echo '======================================'
            echo 'BackendÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§.'
            echo 'URL: https://be.ssairen.site'
        }
        failure {
            echo '======================================'
            echo '‚ùå CI/CD ÌååÏù¥ÌîÑÎùºÏù∏ Ïã§Ìå®!'
            echo '======================================'
            sh '''
                echo "Backend Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏:"
                sudo docker logs ${CONTAINER_NAME} --tail 100 || echo "Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."

                echo ""
                echo "Ïã§Ìñâ Ï§ëÏù∏ Ïª®ÌÖåÏù¥ÎÑà:"
                sudo docker ps -a | grep backend || echo "backend Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            '''
        }
        always {
            echo '======================================'
            echo 'Pipeline Ï¢ÖÎ£å'
            echo '======================================'
        }
    }
}

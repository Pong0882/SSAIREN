pipeline {
    agent any

    environment {
        BACKEND_DIR = 'BE/SSAIREN'
        DOCKER_COMPOSE = 'docker-compose -f docker-compose.blue-green.yml'
        ACTIVE_COLOR_FILE = '/var/jenkins_home/active_color'
        NGINX_CONTAINER = 'nginx-server'
    }

    stages {
        stage('Checkout') {
            steps {
                echo '======================================'
                echo 'Git Repository Checkout'
                echo '======================================'
                checkout scm
                sh 'git branch'
                sh 'pwd'
                sh 'ls -la'
            }
        }

        stage('Determine Colors') {
            steps {
                echo '======================================'
                echo 'Determining Active and Target Colors'
                echo '======================================'
                script {
                    def activeColor = 'blue'

                    // active_color ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ ÏùΩÍ∏∞
                    if (fileExists(env.ACTIVE_COLOR_FILE)) {
                        activeColor = readFile(env.ACTIVE_COLOR_FILE).trim()
                        echo "Í∏∞Ï°¥ ÌôúÏÑ± ÏÉâÏÉÅ ÌååÏùº Î∞úÍ≤¨: ${activeColor}"
                    } else {
                        echo "ÌôúÏÑ± ÏÉâÏÉÅ ÌååÏùº ÏóÜÏùå. Í∏∞Î≥∏Í∞í(blue) ÏÇ¨Ïö©"
                    }

                    // ÌÉÄÍπÉ ÏÉâÏÉÅ Í≤∞Ï†ï (ÌòÑÏû¨ÏôÄ Î∞òÎåÄ)
                    def targetColor = (activeColor == 'blue') ? 'green' : 'blue'

                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "ÌòÑÏû¨ ÌôúÏÑ± ÏÉâÏÉÅ: ${activeColor}"
                    echo "Ïù¥Î≤à Î∞∞Ìè¨ ÎåÄÏÉÅ ÏÉâÏÉÅ: ${targetColor}"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                    env.ACTIVE_COLOR = activeColor
                    env.TARGET_COLOR = targetColor
                }
            }
        }

        stage('Setup Environment') {
            steps {
                echo '======================================'
                echo 'Setting up Environment Variables'
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    withCredentials([file(credentialsId: 'backend-env-file', variable: 'ENV_FILE')]) {
                        sh '''
                            rm -f .env
                            cat $ENV_FILE > .env
                            echo ".env ÌååÏùº ÏÉùÏÑ± ÏôÑÎ£å"
                            ls -la .env
                        '''
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo '======================================'
                echo "Building Docker Image for ${TARGET_COLOR}"
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    sh '''
                        ${DOCKER_COMPOSE} build --no-cache backend-${TARGET_COLOR}
                    '''
                }
            }
        }

        stage('Deploy Target Container') {
            steps {
                echo '======================================'
                echo "Deploying backend-${TARGET_COLOR} Container"
                echo '======================================'
                dir("${BACKEND_DIR}") {
                    sh '''
                        echo "Stopping existing backend-${TARGET_COLOR} container if running..."
                        ${DOCKER_COMPOSE} stop backend-${TARGET_COLOR} || true

                        echo "Starting backend-${TARGET_COLOR} container..."
                        ${DOCKER_COMPOSE} up -d backend-${TARGET_COLOR}

                        echo "backend-${TARGET_COLOR} Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë ÏôÑÎ£å"
                    '''
                }
            }
        }

        stage('Wait for Startup') {
            steps {
                echo '======================================'
                echo "Waiting for backend-${TARGET_COLOR} Startup"
                echo '======================================'
                script {
                    echo "Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë ÎåÄÍ∏∞ Ï§ë (30Ï¥à)..."
                    sleep(time: 30, unit: 'SECONDS')
                }
            }
        }

        stage('Health Check Target') {
            steps {
                echo '======================================'
                echo "Health Check for backend-${TARGET_COLOR}"
                echo '======================================'
                script {
                    def maxRetries = 5
                    def retryCount = 0
                    def healthCheckPassed = false

                    while (retryCount < maxRetries && !healthCheckPassed) {
                        try {
                            def result = sh(
                                script: "docker exec backend-${TARGET_COLOR} wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health/liveness",
                                returnStatus: true
                            )

                            if (result == 0) {
                                healthCheckPassed = true
                                echo "‚úì Health Check ÏÑ±Í≥µ! backend-${TARGET_COLOR} Ï†ïÏÉÅ ÏûëÎèô Ï§ë"
                            } else {
                                retryCount++
                                if (retryCount < maxRetries) {
                                    echo "Health Check Ïã§Ìå®. Ïû¨ÏãúÎèÑ ${retryCount}/${maxRetries}..."
                                    sleep(time: 10, unit: 'SECONDS')
                                }
                            }
                        } catch (Exception e) {
                            retryCount++
                            if (retryCount < maxRetries) {
                                echo "Health Check Ïò§Î•ò: ${e.message}. Ïû¨ÏãúÎèÑ ${retryCount}/${maxRetries}..."
                                sleep(time: 10, unit: 'SECONDS')
                            }
                        }
                    }

                    if (!healthCheckPassed) {
                        error "‚úó Health Check Ïã§Ìå®! backend-${TARGET_COLOR}Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
                    }
                }
            }
        }

        stage('Switch Nginx Upstream') {
            steps {
                echo '======================================'
                echo "Switching Nginx to backend-${TARGET_COLOR}"
                echo '======================================'
                script {
                    sh """
                        echo "Nginx ÏÑ§Ï†ïÏùÑ backend-${TARGET_COLOR}Î°ú Ï†ÑÌôò Ï§ë..."

                        # Nginx Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥ÏóêÏÑú symlink Î≥ÄÍ≤Ω
                        docker exec ${NGINX_CONTAINER} sh -c '\\
                            ln -sf /etc/nginx/conf.d/backend-${TARGET_COLOR}.conf.template /etc/nginx/conf.d/backend-be.conf && \\
                            nginx -t && \\
                            nginx -s reload \\
                        '

                        echo "‚úì Nginx Ï†ÑÌôò ÏôÑÎ£å: backend-${TARGET_COLOR} ÌôúÏÑ±Ìôî"
                    """
                }
            }
        }

        stage('Update Active Color') {
            steps {
                echo '======================================'
                echo 'Updating Active Color File'
                echo '======================================'
                script {
                    writeFile file: env.ACTIVE_COLOR_FILE, text: "${TARGET_COLOR}\n"
                    echo "‚úì ÌôúÏÑ± ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${TARGET_COLOR}"
                    echo "Îã§Ïùå Î∞∞Ìè¨ Ïãú ${ACTIVE_COLOR} Ïª®ÌÖåÏù¥ÎÑàÎ°ú Î∞∞Ìè¨Îê©ÎãàÎã§."
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo '======================================'
                echo 'Verifying Blue-Green Deployment'
                echo '======================================'
                sh """
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "Ïã§Ìñâ Ï§ëÏù∏ Backend Ïª®ÌÖåÏù¥ÎÑà:"
                    docker ps --filter "name=backend-" --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"

                    echo ""
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "ÌòÑÏû¨ ÌôúÏÑ± Ïª®ÌÖåÏù¥ÎÑà (${TARGET_COLOR}) Î°úÍ∑∏ (ÏµúÍ∑º 20Ï§Ñ):"
                    docker logs backend-${TARGET_COLOR} --tail 20

                    echo ""
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏:"
                    docker network inspect ssairen-net | grep -A 3 "backend-"
                """
            }
        }

        stage('Cleanup Old Container (Optional)') {
            steps {
                echo '======================================'
                echo 'Cleaning Up Previous Active Container'
                echo '======================================'
                script {
                    // Ïù¥Ï†Ñ ÌôúÏÑ± Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                    // ÌïÑÏöîÏãú Ï£ºÏÑù Ìï¥Ï†úÌïòÏó¨ ÏÇ¨Ïö©
                    echo "Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà(backend-${ACTIVE_COLOR}) Ï†ïÎ¶¨Îäî ÏàòÎèôÏúºÎ°ú ÏßÑÌñâÌïòÏÑ∏Ïöî."
                    echo "ÏûêÎèô Ï†ïÎ¶¨Î•º ÏõêÌïòÎ©¥ ÏïÑÎûò Ï£ºÏÑùÏùÑ Ìï¥Ï†úÌïòÏÑ∏Ïöî:"
                    echo "# docker-compose -f docker-compose.blue-green.yml stop backend-${ACTIVE_COLOR}"

                    // ÏûêÎèô Ï†ïÎ¶¨Î•º ÏõêÌïòÎ©¥ ÏïÑÎûò Ï£ºÏÑù Ìï¥Ï†ú
                    // dir("${BACKEND_DIR}") {
                    //     sh """
                    //         echo "Stopping backend-${ACTIVE_COLOR}..."
                    //         ${DOCKER_COMPOSE} stop backend-${ACTIVE_COLOR} || true
                    //     """
                    // }
                }
            }
        }
    }

    post {
        success {
            echo '======================================'
            echo 'üéâ Blue-Green Î∞∞Ìè¨ ÏÑ±Í≥µ!'
            echo '======================================'
            echo "‚úì ÏÉà Î≤ÑÏ†ÑÏù¥ backend-${TARGET_COLOR} Ïª®ÌÖåÏù¥ÎÑàÏóê Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§."
            echo "‚úì NginxÍ∞Ä backend-${TARGET_COLOR}Î°ú Ìä∏ÎûòÌîΩÏùÑ ÎùºÏö∞ÌåÖ Ï§ëÏûÖÎãàÎã§."
            echo "‚úì be.ssairen.site ÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•Ìï©ÎãàÎã§."
            echo ""
            echo "Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà backend-${ACTIVE_COLOR}Îäî Î∞±ÏóÖÏö©ÏúºÎ°ú Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§."
        }
        failure {
            echo '======================================'
            echo '‚ùå Blue-Green Î∞∞Ìè¨ Ïã§Ìå®!'
            echo '======================================'
            sh """
                echo "Ïã§Ìå®Ìïú Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏:"
                docker logs backend-${TARGET_COLOR} --tail 100 || echo "Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."

                echo ""
                echo "Ïã§Ìñâ Ï§ëÏù∏ Backend Ïª®ÌÖåÏù¥ÎÑà:"
                docker ps -a --filter "name=backend-" --format "table {{.Names}}\\t{{.Status}}"

                echo ""
                echo "Í∏∞Ï°¥ backend-${ACTIVE_COLOR} Ïª®ÌÖåÏù¥ÎÑàÎäî Ïó¨Ï†ÑÌûà ÌôúÏÑ± ÏÉÅÌÉúÏûÖÎãàÎã§."
            """
        }
        always {
            echo '======================================'
            echo 'Blue-Green Pipeline Ï¢ÖÎ£å'
            echo '======================================'
        }
    }
}
